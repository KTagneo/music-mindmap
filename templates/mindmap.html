<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŒì•… ë§ˆì¸ë“œë§µ</title>
    <style>
        body { text-align: center; font-family: sans-serif; }
        .mindmap-container { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 50px; }
        .center-node { margin: 20px; }
        .center-node img { width: 250px; height: 250px; border-radius: 50%; border: 5px solid #1DB954; }
        .recommendations-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; width: 600px; }
        .rec-node { margin: 15px; }
        .rec-node img { width: 120px; height: 120px; border-radius: 50%; }
        a { text-decoration: none; color: black; }
        .album-cover { cursor: pointer; }

        /* --- íŒì—… í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ ì¶”ê°€ --- */
        #player-popup {
            display: none; /* ì²˜ìŒì—ëŠ” ìˆ¨ê²¨ë‘  */
            position: fixed; /* í™”ë©´ì— ê³ ì • */
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* ë°˜íˆ¬ëª… ê²€ì€ ë°°ê²½ */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
        }
        #player-container {
            position: relative;
            padding: 20px;
            background-color: black;
            border-radius: 10px;
        }
        #close-popup {
            position: absolute;
            top: -15px; right: -15px;
            width: 30px; height: 30px;
            border-radius: 50%;
            border: none;
            background-color: white;
            color: black;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <a href="/"><h1>Music Mindmap Store</h1></a>

    <div class="center-node">
        <div class="album-cover" data-track-name="{{ center_track.name }}" data-artist-name="{{ center_track.artists[0].name }}"> 
            <img src="{{ center_track.album.images[0].url }}" alt="{{ center_track.name }}">
        </div>
        <h2>{{ center_track.name }}</h2>
        <p>{{ center_track.artists[0].name }}</p>
    </div>

    <form action="/select-tracks" method="GET" style="margin: 20px 0;">
        <button type="submit">ğŸ’¿ ë‚˜ë§Œì˜ CD ë§Œë“¤ëŸ¬ ê°€ê¸°</button>
    </form>

    <hr>
    <h3>ì´ëŸ° ë…¸ë˜ëŠ” ì–´ë– ì„¸ìš”?</h3>

    <div class="recommendations-container">
        {% for rec in recommendations %}
            <div class="rec-node">
                <div class="album-cover" data-track-name="{{ rec.name }}" data-artist-name="{{ rec.artists[0].name }}" data-href="/recommendations/{{ rec.id }}">
                    {% if rec.album.images %}
                        <img src="{{ rec.album.images[0].url }}" alt="{{ rec.name }}">
                    {% else %}
                        <div style="width:120px; height:120px; background-color:#ccc; border-radius:50%; display:flex; align-items:center; justify-content:center;">?</div>
                    {% endif %}
                    <p><b>{{ rec.name }}</b></p>
                    <p>{{ rec.artists[0].name }}</p>
                </div>
            </div>
        {% endfor %}
    </div>

    <div id="player-popup">
        <div id="player-container">
            <button id="close-popup">X</button>
            <div id="player"></div> </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const playerPopup = document.getElementById('player-popup');
        const closeButton = document.getElementById('close-popup');
        const albumCovers = document.querySelectorAll('.album-cover');
        let player;

        // ìœ íŠœë¸Œ í”Œë ˆì´ì–´ APIê°€ ì¤€ë¹„ë˜ë©´ ì´ í•¨ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ í˜¸ì¶œí•¨
        function onYouTubeIframeAPIReady() {
            // í”Œë ˆì´ì–´ ê°ì²´ëŠ” ë‚˜ì¤‘ì— í´ë¦­ ì‹œ ìƒì„±
        }
        
        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ë‹«ê³  ì˜ìƒ ì •ì§€
        closeButton.addEventListener('click', () => {
            playerPopup.style.display = 'none';
            if (player) {
                player.stopVideo();
            }
        });

        albumCovers.forEach(cover => {
            cover.addEventListener('click', (event) => {
                const trackName = cover.dataset.trackName;
                const artistName = cover.dataset.artistName;
                const href = cover.dataset.href;

                // Shift í‚¤ë¥¼ ëˆ„ë¥´ê³  í´ë¦­í•˜ë©´ í˜ì´ì§€ ì´ë™, ê·¸ëƒ¥ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë“£ê¸°
                if (event.shiftKey && href) {
                    window.location.href = href;
                    return;
                }

                // 1. ìš°ë¦¬ ì„œë²„ì— ë¹„ë””ì˜¤ IDë¥¼ ìš”ì²­
                fetch(`/api/get-video-id?track=${encodeURIComponent(trackName)}&artist=${encodeURIComponent(artistName)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.video_id) {
                            playerPopup.style.display = 'flex'; // íŒì—…ì°½ ë³´ì´ê¸°
                            
                            // 2. ë°›ì•„ì˜¨ ë¹„ë””ì˜¤ IDë¡œ ìœ íŠœë¸Œ í”Œë ˆì´ì–´ ìƒì„±
                            if (player) {
                                player.loadVideoById(data.video_id);
                            } else {
                                player = new YT.Player('player', {
                                    height: '360',
                                    width: '640',
                                    videoId: data.video_id,
                                    events: { 'onReady': (e) => e.target.playVideo() }
                                });
                            }
                        } else {
                            alert('ë¯¸ë¦¬ë“£ê¸°ë¥¼ ìœ„í•œ ë™ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    });
            });
        });
    </script>
</body>
</html>